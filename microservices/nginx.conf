upstream auth_service {
    # Routes to app-auth container on internal port 5000
    server app-auth:5000;
}

upstream inventory_service {
    # Routes to app-inventory container on internal port 5000
    server app-inventory:5000;
}

upstream gatcha_service {
    # Routes to app-gatcha container on internal port 5000
    server app-gatcha:5000;
}

upstream trade_service {
    # Routes to app-trade container on internal port 5000
    server app-trade:5000;
}

upstream battle_service {
    # Routes to app-battle container on internal port 5001 (SocketIO)
    server app-battle:5001;
}

server {
    listen 80;
    server_name localhost;

    # 1. Root Path (/)
    # Serves the main index.html file from the Auth Service.
    location / {
        proxy_pass http://auth_service/;
        proxy_set_header Host $host;
    }

    # 2. API Routes - AUTH
    location /api/auth/ {
        proxy_pass http://auth_service/api/auth/;
        proxy_set_header Host $host;
    }

    # 3. API Routes - INVENTORY
    location /api/inventory/ {
        proxy_pass http://inventory_service/api/inventory/;
        proxy_set_header Host $host;
    }

    # 3b. API Routes - RELEASE (for inventory release)
    location /api/release/ {
        proxy_pass http://inventory_service/api/release/;
        proxy_set_header Host $host;
    }

    # 4. API Routes - GATCHA
    # Canonicalize: rewrite /api/gatcha to /api/gatcha/ (trailing slash)
    location = /api/gatcha {
        return 307 /api/gatcha/;
    }
    location /api/gatcha/ {
        proxy_pass http://gatcha_service/api/gatcha/;
        proxy_set_header Host $host;
    }
    
    # 5. API Routes - TRADE
    location /api/trade/ {
        proxy_pass http://trade_service/api/trade/;
        proxy_set_header Host $host;
    }

    # 6. SocketIO Proxy (Required for WebSockets)
    location /socket.io {
        # Note: We pass the entire request to the battle service
        proxy_pass http://battle_service;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # WebSocket settings
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        proxy_buffering off;
        
        # Necessary for Socket.IO path-based routing
        proxy_set_header X-Socket-IO-Path /socket.io;
    }
}